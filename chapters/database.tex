\chapter{Database}
One of our four main parts of our diploma thesis was the data design and \gls{db}. We started with creating an entity relationship diagram. This \gls{erd} was the base of our \gls{db}. Because of constant changes in our program structure, we had to change the \gls{db} structure too. 
\section{Entity Relationship Diagram}
\begin{center}
\includegraphics[width=0.9\textwidth]{bilder/ERD_new}
\end{center} 
Customer(svnr, firstname, lastname, dateofbirth, addressIDFK)\newline
Vehicle(vehicleID, svnrFK)\newline
Address(addressID, street, zipcode)\newline
TrackingHardware(serialNumber, svnrFK, description, licenceIDFK)\newline
Licence(licenceID, svnrFK, dateofactivation)\newline
Track(id, serialNumberFK, timestamp)\newline
Point(id, timestamp, (track\_id,track\_serialNumber)FK ,coordinateX, coordinateXError, coordinateY, coordinateYError, acceleration, altitude, altitudeError, distance)\newline
Vehicle\_TrackingHardware(serialNumberFK, vehicleIDFK)
\section{Entities}
\subsection{Customer}
The entity Customer has the social security number as the primary key. Additional attributes are the firstname, the lastname and the date of birth of the person the account belongs to. As you can see in the \gls{erd}, every customer has one reported address and an address can belong to zero or more customers. Due to this, the entity customer contains a foreign key with the id from the address. A customer can only register once, so every customer can have zero or one AdministrationAccount, depending on if he is already registered. Clearly, an account can only belong to one customer so it is well defined who is the owner of the device. There can be a customer who drives more than one vehicle so if he changes to another car, of course he does not have to buy a new device. He can use it for zero or more vehicles. The vehicle is only reported for one customer. This is because if the car is used by more than one person they will not have more than one account. Even if a customer usually only needs one device, it is possible for him to buy zero or more devices. And clearly he does not have to create a new administration account for each of them. But the other way around, every tracking hardware belongs to only one customer.
\subsection{Vehicle}
Every Vehicle has its own unique vehicle id to identify it. This id is also used in our \gls{db} to identify different vehicles. The vehicle is only reported for one customer. This is because if the car is used by more than one person they will not have more than one account. In one vehicle you can place zero or more tracking hardwares and one tracking hardware can be used in zero or more vehicles too, so this is called a “n to m relationship”. We splitted this relationship to an extra entity called Vehicle\_TrackingHardware. This entity contains the two primary keys of the first two tables as primary and foreign key at once.
\subsection{Address}
The entity Address has the unique address id for primary key to identify. It also contains the street name and the zipcode of each address. As you can see in the diagram, one address can belong to zero or more customers but one customer can only be reported to one address.
\subsection{TrackingHardware}
In our \gls{db}, every TrackingHardware is identified by its unique serial number. An additional attribute in this table is the description of the device. One hardware can only belong to one customer and one customer can own zero or more tracking hardwares. So we had to create a foreign key called svnr of the social security number of the Customer. Because of the already mentioned “n to m relationship” between TrackingHardware and Vehicle, you can see an extra entity called Vehicle\_TrackingHardware. With every purchase on a tracking hardware, you acquire an associated Licence. So this table includes the primary key of the Licence called licenceID as a foreign key. A Licence can belong to zero or one device. If the \gls{rpi2} is not purchased yet, the licence is not used. One TrackingHardware has already tracked zero or more Tracks and one Track always belongs to exactly one device.
\subsection{Licence}
The table Licence consists of its own unique licenceID. The svnr is the connection to the Customer Table and is a foreign key in this table. The Licence belongs to one Customer and the Customer can have zero and more Licences. The dateofactivation attribute is, as the names says, the date when the licence was activated on the web portal with the associated device.
\subsection{Track}
Every Track belongs to one TrackingHardware. This Track contains all the Points which belong to this Track. The identifier for the Track is a \gls{uuid}, generated by the program on the \gls{rpi2} and the serialNumber from the TrackingHardware. The table also has a timestamp generated at the start of the program on the \gls{rpi2}.
\subsection{Point}
The greatest part of the information is stored in the Point table. There the identifier is also a \gls{uuid}, generated by the program on the \gls{rpi2}. The primary key is compound of the id, and the primary key from the Track table which is also the foreign key in the Point Table. The identifier from Track is composed of the tack\_id and the serialNumber. The other attributes are the coordinates, the variance of the coordinates, the acceleration, the altitude and the variance of the altitude. The last thing is the distance, which is empty at the time being. Every Point belongs to one Track and every Track contains zero or more points.
\section{Data Definition Language}
\begin{minted}{SQL}
CREATE TABLE Address(
addressID INT(6) AUTO_INCREMENT PRIMARY KEY,
street VARCHAR(30),
zipcode INT(6)
);
CREATE TABLE Customer(
svnr INT(6) PRIMARY KEY,
firstname VARCHAR(30) NOT NULL,
lastname VARCHAR(30) NOT NULL,
email VARCHAR(50) NOT NULL,
dateofbirth DATE NOT NULL,
addressID INT(6),
FOREIGN KEY fk_Customer(addressID)
REFERENCES Address(addressID)
);

CREATE TABLE Vehicle(
vehicleID INT(8) AUTO_INCREMENT PRIMARY KEY,
svnr INT(6),
FOREIGN KEY fk_Vehicle(svnr)
REFERENCES Customer(svnr)
);

CREATE TABLE Licence(
licenceID INT(8) AUTO_INCREMENT PRIMARY KEY,
svnr INT(6),
dateofactivation DATE NOT NULL,
FOREIGN KEY fk_account (accountID)
REFERENCES AdministrationAccount(accountID)
);

CREATE TABLE TrackingHardware(
serialNumber INT(8) AUTO_INCREMENT PRIMARY KEY,
svnr INT(6),
description VARCHAR(100),
licenceID INT(8),
FOREIGN KEY fk_trackHardw(svnr)
REFERENCES Customer(svnr),
FOREIGN KEY fk_licence(licenceID)
REFERENCES Licence(licenceID)
);

CREATE TABLE VehicleTrackingHardware(
serialNumber INT(8),
vehicleID INT(8),
timestamp DATE NOT NULL,
PRIMARY KEY (serialNumber, vehicleID),
FOREIGN KEY fk_vth_serialNumber(serialNumber)
REFERENCES TrackingHardware(serialNumber),
FOREIGN KEY fk_vth_vehicleID(vehicleID)
REFERENCES Vehicle(vehicleID)
);

CREATE TABLE Track(
id VARCHAR(255),
serialNumber INT(8),
timestamp BIGINT NOT NULL,
PRIMARY KEY(id, serialNumber),
FOREIGN KEY fk_track_serial(serialNumber)
REFERENCES TrackingHardware(serialNumber)
);

CREATE TABLE Point(
id VARCHAR(255),
timestamp BIGINT NOT NULL,
track_serialNumber INT(8),
track_id VARCHAR(255),
coordinateY DOUBLE NOT NULL,
coordinateYError DOUBLE NOT NULL,
coordinateX DOUBLE NOT NULL,
coordinateXError DOUBLE NOT NULL,
acceleration DOUBLE NOT NULL,
altitude DOUBLE NOT NULL,
altitudeError DOUBLE NOT NULL,
distance DOUBLE,
PRIMARY KEY(id, timestamp, track_serialNumber,track_id),
FOREIGN KEY fk_point_track(track_serialNumber, track_id)
REFERENCES Track(serialNumber, id)
);
\end{minted}
\section{Data Manipulation Language}
\begin{minted}{SQL}
INSERT INTO Address(addressID, street, zipcode)
VALUES(1,'Blumenweg',8430);
INSERT INTO Customer(svnr, firstname, lastname, email, dateofbirth, addressID)
VALUES(4523, 'Karl', 'Huber', 'karl.huber@gmail.com',
DATE_FORMAT('1970-12-09','%Y-%m-%d'),1);
INSERT INTO Vehicle(vehicleID, svnr)
VALUES(832,4523);
INSERT INTO Licence(licenceID, svnr, dateofactivation)
VALUES(832495,4523,DATE_FORMAT('2016-01-20','%Y-%m-%d'));
INSERT INTO TrackingHardware(serialNumber, description, licenceID)
VALUES(1234, 'Karlis Raspi', 832495);
INSERT INTO VehicleTrackingHardware(serialNumber, vehicleID, timestamp)
VALUES(1234, 832, DATE_FORMAT('2016-01-24','%Y-%m-%d'));
INSERT INTO Track ('id', 'serialNumber', 'timestamp') 
VALUES('018f8ff5-395b-42d2-b2f6-5c976292cd5e', 1234, 1455535245172);
INSERT INTO Point ('id', 'timestamp', 'track_serialNumber', 'track_id', 
'coordinateY', 'coordinateYError', 'coordinateX', 'coordinateXError', 
'acceleration', 'altitude', 'altitudeError', 'distance') 
VALUES('007dae03-c915-4aae-baf9-2b7c42a41e43', 1455535245172, 1234, 
'1f114f58-fd0c-4da6-a1b6-571ae9e79748', 46.78029, 14.815, 15.54794, 10.697, 
0.103, 277.3, 18.17, 0),
('dedc843e-e29b-4a0d-b32d-20cb718088ea', 1455535282394, 1234, 
'1f114f58-fd0c-4da6-a1b6-571ae9e79748', 46.780401667, 14.815, 15.547526667, 
10.697, 7.562, 279, 16.56, 0);
\end{minted}
\section{Problems}
While we tried to insert testing data into our \gls{db}, we noticed that it wasn’t possible to save the timestamp as milliseconds. After researches, we discovered that the problem was the version of our \gls{mysql} \gls{db} (version 5.5.46). Due to this problem we had to change the datatype of our timestamp into bigint.